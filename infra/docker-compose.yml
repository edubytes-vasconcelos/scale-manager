services:
  scale-manager-voluntarios:
    container_name: scale-manager-voluntarios
    image: scale-manager/voluntarios:latest

    build:
      context: ..
      dockerfile: infra/Dockerfile

    restart: unless-stopped

    env_file:
      - ../.env

    networks:
      - traefik
      - scale-manager-net

    # ❌ NÃO exponha portas
    # Traefik é o único dono de 80/443

    labels:
      - "traefik.enable=true"

      # Router HTTP (redireciona para HTTPS)
      - "traefik.http.routers.voluntarios.rule=Host(`voluntarios.seventech.cloud`)"
      - "traefik.http.routers.voluntarios.entrypoints=web"
      - "traefik.http.routers.voluntarios.middlewares=redirect-to-https"

      # Router HTTPS
      - "traefik.http.routers.voluntarios-secure.rule=Host(`voluntarios.seventech.cloud`)"
      - "traefik.http.routers.voluntarios-secure.entrypoints=websecure"
      - "traefik.http.routers.voluntarios-secure.tls=true"
      - "traefik.http.routers.voluntarios-secure.tls.certresolver=le"

      # Service
      - "traefik.http.services.voluntarios.loadbalancer.server.port=80"

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  traefik:
    external: true
  scale-manager-net:
    external: true